// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x", "darwin-arm64"]
}

generator json {
  provider = "prisma-json-types-generator"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // In development, you can skip migrations and use db push directly
  // This allows rapid schema changes without migration files
}

enum UserRole {
  user
  org_admin
  super_admin

  @@map("user_role")
}

enum ProfileStatus {
  pending
  active
  suspended

  @@map("profile_status")
}

enum PairingPeriodStatus {
  upcoming
  active
  closed

  @@map("pairing_period_status")
}

enum PairingStatus {
  planned
  matched
  met
  not_met
  not_planned
  unspecified
  cancelled

  @@map("pairing_status")
}

enum CalendarEventType {
  availability
  unavailability

  @@map("calendar_event_type")
}

enum MeetingConfirmationStatus {
  pending
  confirmed
  rejected
  proposed

  @@map("meeting_confirmation_status")
}

enum TagCategory {
  HOBBY
  INTEREST

  @@map("tag_category")
}

enum AchievementType {
  milestone
  social
  engagement
  consistency
  legendary

  @@map("achievement_type")
}

model Organization {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  code      String   @unique
  size      Int?
  address   String?
  imageUrl  String?  @map("image_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users           User[]
  departments     Department[]
  pairingPeriods  PairingPeriod[]
  pairings        Pairing[]
  bans            Ban[]
  algorithmConfig AlgorithmSetting?
	inviteCodes     InviteCode[]
  cycleParticipations CycleParticipation[]

  @@map("organizations")
}

model Department {
  id             String   @id @default(uuid()) @db.Uuid
  name           String
  description    String?  @db.Text
  organizationId String   @map("organization_id") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users        User[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("departments")
}

model Tag {
  id       String      @id @default(uuid()) @db.Uuid
  name     String      @unique
  category TagCategory
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  userTags UserTag[]

  @@index([category])
  @@map("tags")
}

model UserTag {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tagId     String   @map("tag_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([userId, tagId])
  @@index([userId])
  @@index([tagId])
  @@map("user_tags")
}
model User {
  id                String             @id @db.Uuid
  organizationId    String             @map("organization_id") @db.Uuid
  organization      Organization       @relation(fields: [organizationId], references: [id])
  departmentId      String?            @map("department_id") @db.Uuid
  department        Department?        @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  email             String
  emailVerified     Boolean
  passwordHash      String?            @map("password_hash")
  firstName         String?            @map("first_name")
  lastName          String?            @map("last_name")
  about             String?            @db.Text
  location          String?
  position          String?
  preferredActivity String?            @map("preferred_activity")
  profileImageUrl   String?            @map("avatar_url") @db.Text
  isActive          Boolean            @default(true) @map("is_active")
  idealColleagueUsesRemaining Int @default(2) @map("ideal_colleague_uses_remaining")
  suspendedUntil    DateTime?          @map("suspended_until") @db.Date
  image             String?            @db.Text
  createdAt         DateTime
  updatedAt         DateTime
  role              UserRole           @default(user)
  profileStatus     ProfileStatus      @default(pending)
  supabaseUserId    String?            @unique
  pairingsAsUserA   Pairing[]          @relation("UserPairingA")
  pairingsAsUserB   Pairing[]          @relation("UserPairingB")
  messages          Message[]          @relation("MessageSender")
  calendarEvents    CalendarEvent[]
  meetingEventsA    MeetingEvent[]     @relation("MeetingEventUserA")
  meetingEventsB    MeetingEvent[]     @relation("MeetingEventUserB")
  reportsAuthored   Report[]           @relation("ReportsAuthored")
  reportsReceived   Report[]           @relation("ReportsReceived")
  reportsResolved   Report[]           @relation("ReportsResolved")
  bans              Ban[]              @relation("UserBans")
  bansIssued        Ban[]              @relation("UserBanActions")
  blocksInitiated   UserBlock[]        @relation("UserBlocksBlocker")
  blocksReceived    UserBlock[]        @relation("UserBlocksBlocked")
  userTags          UserTag[]
	inviteCodesCreated InviteCode[]
  ratings           Rating[]           @relation("UserRatings")
  userAchievements  UserAchievement[]
  cycleParticipations CycleParticipation[]

  @@map("user")
}

model PairingPeriod {
  id             String              @id @default(uuid()) @db.Uuid
  organizationId String              @map("organization_id") @db.Uuid
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  startDate      DateTime?           @map("start_date") @db.Date
  endDate        DateTime?           @map("end_date") @db.Date
  status         PairingPeriodStatus @default(active)
  createdAt      DateTime            @default(now()) @map("created_at")

  pairings Pairing[]

  @@index([organizationId])
  @@map("pairing_periods")
}

model Pairing {
  id             String        @id @default(uuid()) @db.Uuid
  periodId       String        @map("period_id") @db.Uuid
  organizationId String?       @map("organization_id") @db.Uuid
  userAId        String        @map("user_a_id") @db.Uuid
  userBId        String        @map("user_b_id") @db.Uuid
  status         PairingStatus @default(planned)
  createdAt      DateTime      @default(now()) @map("created_at")

  period       PairingPeriod @relation(fields: [periodId], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id])
  userA        User          @relation("UserPairingA", fields: [userAId], references: [id], onDelete: Cascade)
  userB        User          @relation("UserPairingB", fields: [userBId], references: [id], onDelete: Cascade)
  messages     Message[]
  reports      Report[]
  meetingEvents MeetingEvent[]

  @@unique([periodId, userAId, userBId])
  @@index([organizationId])
  @@index([status])
  @@index([userAId, userBId])
  @@map("pairings")
}

model Message {
  id        String   @id @default(uuid()) @db.Uuid
  pairingId String   @map("pairing_id") @db.Uuid
  senderId  String   @map("sender_id") @db.Uuid
  content   String   @db.Text
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  pairing Pairing @relation(fields: [pairingId], references: [id], onDelete: Cascade)
  sender  User    @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([pairingId])
  @@index([senderId])
  @@map("messages")
}

model CalendarEvent {
  id                 String                @id @default(uuid()) @db.Uuid
  userId             String                @map("user_id") @db.Uuid
  user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type               CalendarEventType     @map("type")
  title              String?
  description        String?               @db.Text
  
  startDateTime      DateTime              @map("start_date_time")
  endDateTime        DateTime              @map("end_date_time")
  
  rrule              String?               @db.Text
  rruleRecurringId   String?               @map("rrule_recurring_id")
  
  exceptionDates     String?               @map("exception_dates") @db.Text
  exceptionRrules    String?               @map("exception_rrules") @db.Text
  
  externalId         String?               @map("external_id")
  externalSource     String?               @map("external_source")
  
  deletedAt          DateTime?             @map("deleted_at")
  
  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")

  @@index([userId])
  @@index([type])
  @@index([startDateTime])
  @@index([rruleRecurringId])
  @@index([externalId])
  @@index([externalSource])
  @@map("calendar_events")
}

model MeetingEvent {
  id                 String                         @id @default(uuid()) @db.Uuid
  pairingId          String?                        @map("pairing_id") @db.Uuid
  pairing            Pairing?                       @relation(fields: [pairingId], references: [id], onDelete: SetNull)
  
  userAId            String                         @map("user_a_id") @db.Uuid
  userA              User                           @relation("MeetingEventUserA", fields: [userAId], references: [id], onDelete: Cascade)
  
  userBId            String                         @map("user_b_id") @db.Uuid
  userB              User                           @relation("MeetingEventUserB", fields: [userBId], references: [id], onDelete: Cascade)
  
  createdByUserId    String                         @map("created_by_user_id") @db.Uuid
  
  startDateTime      DateTime                       @map("start_date_time")
  endDateTime        DateTime                       @map("end_date_time")
  
  userAConfirmationStatus    MeetingConfirmationStatus  @default(pending) @map("user_a_confirmation_status")
  userBConfirmationStatus    MeetingConfirmationStatus  @default(pending) @map("user_b_confirmation_status")
  
  userAProposedStartDateTime DateTime?               @map("user_a_proposed_start_date_time")
  userAProposedEndDateTime   DateTime?               @map("user_a_proposed_end_date_time")
  userBProposedStartDateTime DateTime?               @map("user_b_proposed_start_date_time")
  userBProposedEndDateTime   DateTime?               @map("user_b_proposed_end_date_time")
  
  userANote          String?                        @db.Text @map("user_a_note")
  userBNote          String?                        @db.Text @map("user_b_note")
  
  cancelledAt        DateTime?                      @map("cancelled_at")
  cancelledByUserId  String?                        @map("cancelled_by_user_id") @db.Uuid
  cancellationReason String?                        @db.Text @map("cancellation_reason")
  
  createdAt          DateTime                       @default(now()) @map("created_at")
  updatedAt          DateTime                       @updatedAt @map("updated_at")

  @@index([pairingId])
  @@index([userAId])
  @@index([userBId])
  @@index([userAConfirmationStatus])
  @@index([userBConfirmationStatus])
  @@index([startDateTime])
  @@map("meeting_events")
  
  ratings Rating[]
}

model Rating {
  id              String   @id @default(uuid()) @db.Uuid
  meetingEventId  String   @map("meeting_event_id") @db.Uuid
  meetingEvent    MeetingEvent @relation(fields: [meetingEventId], references: [id], onDelete: Cascade)
  
  userId          String   @map("user_id") @db.Uuid
  user            User     @relation("UserRatings", fields: [userId], references: [id], onDelete: Cascade)
  
  stars           Int      // 0-5 integer
  feedback        String?  @db.Text
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@unique([meetingEventId, userId])
  @@index([userId])
  @@index([meetingEventId])
  @@map("ratings")
}

model Report {
  id             String   @id @default(uuid()) @db.Uuid
  reporterId     String   @map("reporter_id") @db.Uuid
  reportedUserId String   @map("reported_user_id") @db.Uuid
  pairingId      String   @map("pairing_id") @db.Uuid
  reason         String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  resolvedById   String?  @map("resolved_by") @db.Uuid
  resolvedAt     DateTime? @map("resolved_at")
  resolutionNote String?  @map("resolution_note")

  reporter     User    @relation("ReportsAuthored", fields: [reporterId], references: [id])
  reportedUser User    @relation("ReportsReceived", fields: [reportedUserId], references: [id])
  pairing      Pairing @relation(fields: [pairingId], references: [id])
  resolvedBy   User?   @relation("ReportsResolved", fields: [resolvedById], references: [id])

  @@index([reporterId])
  @@index([reportedUserId])
  @@index([pairingId])
  @@map("reports")
}

model Ban {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  reason         String    @db.Text
  bannedById     String    @map("banned_by") @db.Uuid
  createdAt      DateTime  @default(now()) @map("created_at")
  expiresAt      DateTime? @map("expires_at")

  organization Organization  @relation(fields: [organizationId], references: [id])
  user         User          @relation("UserBans", fields: [userId], references: [id])
  bannedBy     User          @relation("UserBanActions", fields: [bannedById], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@map("bans")
}

model AlgorithmSetting {
  id               String   @id @default(uuid()) @db.Uuid
  organizationId   String   @unique @map("organization_id") @db.Uuid
  periodLengthDays Int?     @map("period_length_days")
  randomSeed       Int?     @map("random_seed")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("algorithm_settings")
}

model UserBlock {
  id             String   @id @default(uuid()) @db.Uuid
  blockerId      String   @map("blocker_id") @db.Uuid
  blockedId      String   @map("blocked_id") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at")

  blocker      User         @relation("UserBlocksBlocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked      User         @relation("UserBlocksBlocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@map("user_blocks")
}

model InviteCode {
  id             String    @id @default(uuid()) @db.Uuid
  code           String    @unique
  organizationId String    @map("organization_id") @db.Uuid
  createdById    String    @map("created_by") @db.Uuid
  createdAt      DateTime  @default(now()) @map("created_at")
  expiresAt      DateTime? @map("expires_at")
  usedCount      Int       @default(0) @map("used_count")
  maxUses        Int?      @map("max_uses")
  isActive       Boolean   @default(true) @map("is_active")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([createdById])
  @@map("invite_codes")
}

model Achievement {
  id                String            @id @default(uuid()) @db.Uuid
  name              String            @unique
  description       String            @db.Text
  imageIdentifier   String            @map("image_identifier")
  type              AchievementType   @default(milestone)
  pointValue        Int               @default(10) @map("point_value")
  isActive          Boolean           @default(true) @map("is_active")
  unlockCondition   String?           @map("unlock_condition") @db.Text
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  userAchievements  UserAchievement[]

  @@index([type])
  @@map("achievements")
}

model UserAchievement {
  id                String    @id @default(uuid()) @db.Uuid
  userId            String    @map("user_id") @db.Uuid
  achievementId     String    @map("achievement_id") @db.Uuid
  unlockedAt        DateTime? @map("unlocked_at")
  currentProgress   Int       @default(0) @map("current_progress")
  notificationSent  Boolean   @default(false) @map("notification_sent")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement       Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@map("user_achievements")
}
model CycleParticipation {
  id                      String    @id @default(uuid()) @db.Uuid
  userId                  String    @map("user_id") @db.Uuid
  organizationId          String    @map("organization_id") @db.Uuid
  consecutiveCount        Int       @default(1) @map("consecutive_count")
  lastParticipationCycle  Int?      @map("last_participation_cycle")
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([consecutiveCount])
  @@map("cycle_participations")
}
